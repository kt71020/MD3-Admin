# 統計資料

## 資料定義

- 已進件管道 channel 分類
  - totalApplication: 本月新增數
  - 審核狀態 review_status
    - pedding:擱置 PENDDING 數目
    - reject:拒絕 REJECT 數目
    - approve:核准 APPROVE 數目
  - 處理狀態 status
    - newApplication:0 未處理 數目
    - processing:1 處理中 數目
    - check: 4 複核中 數目
    - colse: 5 結案 數目

## 資料來源

```sql
-- Generated by the database client.
CREATE TABLE application_shop_request(
    id SERIAL NOT NULL,
    uid uuid NOT NULL,
    shop_name varchar(20) NOT NULL,
    shop_contact_name varchar(20),
    shop_city varchar(20) NOT NULL,
    shop_region varchar(20) NOT NULL,
    shop_address varchar(30) NOT NULL,
    shop_phone varchar(20) NOT NULL,
    shop_mobile varchar(20),
    shop_note varchar(50),
    shop_image varchar(200) NOT NULL,
    shop_description varchar(50),
    shop_email varchar(50),
    shop_website varchar(150),
    shop_tax_id varchar(10),
    image_url varchar(500) NOT NULL,
    review_status varchar(20) DEFAULT 'PENDDING'::character varying,
    review_note varchar(150),
    review_at timestamp with time zone,
    review_by uuid,
    review_by_name varchar(20),
    is_close boolean DEFAULT false,
    close_at timestamp with time zone,
    close_by uuid,
    close_by_name varchar(20),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    applicant_identity integer NOT NULL DEFAULT 1,
    status varchar(1) DEFAULT '0'::character varying,
    channel varchar(255) NOT NULL DEFAULT 'SHOP'::character varying,
    PRIMARY KEY(id),
    CONSTRAINT review_status_check CHECK (((review_status)::text = ANY (ARRAY[('PENDDING'::character varying)::text, ('APPROVE'::character varying)::text, ('REJECT'::character varying)::text])))
);
COMMENT ON TABLE application_shop_request IS '商店申請資料';
COMMENT ON COLUMN application_shop_request.id IS '申請序號';
COMMENT ON COLUMN application_shop_request.uid IS '申請人UID';
COMMENT ON COLUMN application_shop_request.shop_name IS '商店名稱';
COMMENT ON COLUMN application_shop_request.shop_contact_name IS '聯絡人姓名';
COMMENT ON COLUMN application_shop_request.shop_city IS '城市';
COMMENT ON COLUMN application_shop_request.shop_region IS '鄉鎮市區';
COMMENT ON COLUMN application_shop_request.shop_address IS '地址';
COMMENT ON COLUMN application_shop_request.shop_phone IS '訂購電話';
COMMENT ON COLUMN application_shop_request.shop_mobile IS '聯絡人電話';
COMMENT ON COLUMN application_shop_request.shop_note IS '訂購附註';
COMMENT ON COLUMN application_shop_request.shop_description IS '商店描述';
COMMENT ON COLUMN application_shop_request.shop_email IS '電子郵件';
COMMENT ON COLUMN application_shop_request.shop_website IS '網址';
COMMENT ON COLUMN application_shop_request.shop_tax_id IS '統一編號';
COMMENT ON COLUMN application_shop_request.image_url IS '目錄網址';
COMMENT ON COLUMN application_shop_request.review_status IS '審核結果';
COMMENT ON COLUMN application_shop_request.review_note IS '審核附註';
COMMENT ON COLUMN application_shop_request.review_at IS '審核時間';
COMMENT ON COLUMN application_shop_request.review_by IS '審核人UID';
COMMENT ON COLUMN application_shop_request.review_by_name IS '審核人姓名';
COMMENT ON COLUMN application_shop_request.is_close IS '是否已結案';
COMMENT ON COLUMN application_shop_request.close_at IS '結案時間';
COMMENT ON COLUMN application_shop_request.close_by IS '結案人UID';
COMMENT ON COLUMN application_shop_request.close_by_name IS '結案人姓名';
COMMENT ON COLUMN application_shop_request.created_at IS '建立時間';
COMMENT ON COLUMN application_shop_request.applicant_identity IS '申請人類別';
COMMENT ON COLUMN application_shop_request.status IS '申請書狀態';
COMMENT ON COLUMN application_shop_request.channel IS '進件管道';

```

## PostgreSQL 語法

> 注意：`review_status` 中的值使用現況拼字 `PENDDING`；處理狀態欄位 `status` 以字元型別儲存（'0','1','4','5'），下列查詢依現況撰寫。

### 本月（依 channel 與總計）

```sql
WITH month_bounds AS (
  SELECT
    date_trunc('month', now())::timestamptz AS month_start,
    (date_trunc('month', now()) + interval '1 month')::timestamptz AS month_end
)
SELECT
  COALESCE(a.channel, 'ALL') AS channel,
  COUNT(*) AS "totalApplication",
  COUNT(*) FILTER (WHERE a.review_status = 'PENDDING') AS "pedding",
  COUNT(*) FILTER (WHERE a.review_status = 'REJECT') AS "reject",
  COUNT(*) FILTER (WHERE a.review_status = 'APPROVE') AS "approve",
  COUNT(*) FILTER (WHERE a.status = '0') AS "newApplication",
  COUNT(*) FILTER (WHERE a.status = '1') AS "processing",
  COUNT(*) FILTER (WHERE a.status = '4') AS "check",
  COUNT(*) FILTER (WHERE a.status = '5') AS "colse"
FROM application_shop_request AS a
JOIN month_bounds AS mb
  ON a.created_at >= mb.month_start
 AND a.created_at <  mb.month_end
GROUP BY ROLLUP (a.channel);
```

### 全時段（依 channel 與總計）

```sql
SELECT
  COALESCE(a.channel, 'ALL') AS channel,
  COUNT(*) AS "totalAll",
  COUNT(*) FILTER (WHERE a.review_status = 'PENDDING') AS "pedding",
  COUNT(*) FILTER (WHERE a.review_status = 'REJECT') AS "reject",
  COUNT(*) FILTER (WHERE a.review_status = 'APPROVE') AS "approve",
  COUNT(*) FILTER (WHERE a.status = '0') AS "newApplication",
  COUNT(*) FILTER (WHERE a.status = '1') AS "processing",
  COUNT(*) FILTER (WHERE a.status = '4') AS "check",
  COUNT(*) FILTER (WHERE a.status = '5') AS "colse"
FROM application_shop_request AS a
GROUP BY ROLLUP (a.channel);
```
